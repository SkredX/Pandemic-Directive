<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pandemic Directive: Zero Hour</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="icon" type="image/png" href="favicon.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3KNYNHZWV1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3KNYNHZWV1');
  </script>

  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <audio id="bgm" loop><source src="bgm.mp3" type="audio/mpeg"></audio>
  <audio id="sfx-typewriter" loop><source src="typewriter.mp3" type="audio/mpeg"></audio>
  <audio id="sfx-radio"><source src="radio.mp3" type="audio/mpeg"></audio>

  <div class="screen-effects">
    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div class="noise"></div>
  </div>

  <div id="loading-overlay">
    <div id="intro-text-container"></div>
    <button id="enter-btn" style="opacity: 0; pointer-events: none; transition: opacity 1s;">INITIALIZE PROTOCOLS</button>
  </div>

  <div id="news-modal-overlay">
    <div class="news-box">
      <div class="news-header-bar">
        <span class="news-icon">âš </span> WORLD NEWS WIRE
      </div>
      <div id="news-content" class="news-content"></div>
      <button id="news-ok-btn">ACKNOWLEDGE</button>
    </div>
  </div>

  <div id="game-container" class="container">
    <div class="system-header">
      <span>SYS.OP.2025</span>
      <span class="blink">ONLINE</span>
    </div>

    <div id="terminal" class="terminal"></div>

    <div class="input-row">
      <input id="choiceInput" type="number" placeholder=">> AWAITING COMMAND" min="1" disabled />
      <button id="submitBtn" disabled>EXECUTE</button>
      <button id="restartBtn" style="display:none;">REBOOT SYSTEM</button>
    </div>

    <footer>
      <p>Decisions are final. History is watching.</p>
    </footer>
  </div>

  <script src="game_core.js"></script>

  <script>
    // --- AUDIO CONTROLLER ---
    const audio = {
      bgm: document.getElementById('bgm'),
      type: document.getElementById('sfx-typewriter'),
      radio: document.getElementById('sfx-radio'),
      startBgm: () => { 
        audio.bgm.volume = 0.5; 
        audio.bgm.play().catch(e => console.log("Audio waiting")); 
      },
      playType: () => { 
        audio.type.currentTime = 0; 
        audio.type.play().catch(e => {}); 
      },
      stopType: () => { 
        audio.type.pause(); 
      },
      playRadio: () => { 
        audio.radio.currentTime = 0; 
        audio.radio.volume = 0.8; 
        audio.radio.play().catch(e => {}); 
      }
    };

    // --- TYPEWRITER EFFECT ---
    function typeText(el, text, speed = 10, cb = null) {
      let i = 0;
      audio.playType();
      el.classList.add("typing-cursor");
      
      function tick() {
        if (i < text.length) {
          if (text.charAt(i) === '\n') {
            el.appendChild(document.createElement('br'));
          } else {
            el.appendChild(document.createTextNode(text.charAt(i)));
          }
          // Auto-scroll terminal
          const t = document.getElementById('terminal');
          if (t) t.scrollTop = t.scrollHeight;
          
          i++;
          setTimeout(tick, speed);
        } else {
          audio.stopType();
          el.classList.remove("typing-cursor");
          if (cb) cb();
        }
      }
      tick();
    }

    // --- NEWS MODAL SYSTEM ---
    const newsOverlay = document.getElementById('news-modal-overlay');
    const newsContent = document.getElementById('news-content');
    const newsOkBtn = document.getElementById('news-ok-btn');
    let pendingGameData = null; 

    function showNews(text, gameData) {
      pendingGameData = gameData; 
      newsContent.textContent = text;
      newsOverlay.style.display = 'flex';
      audio.playRadio();
    }

    newsOkBtn.addEventListener('click', () => {
      newsOverlay.style.display = 'none';
      if(pendingGameData) {
        displayTurn(pendingGameData);
        pendingGameData = null;
      }
    });

    // --- INTRO SEQUENCE ---
    const introText = "Welcome to the command group.\n\nOur nation has just noted a novel infection.\n\nYou are recruited to guide the decision makers towards the right step.\n\nStay prepared to lead from the shadows.";
    const introContainer = document.getElementById('intro-text-container');
    const enterBtn = document.getElementById('enter-btn');
    const loadingOverlay = document.getElementById('loading-overlay');

    window.addEventListener('load', () => {
      setTimeout(() => {
        typeText(introContainer, introText, 30, () => {
          introContainer.innerHTML = introContainer.innerHTML.replace(
            "Stay prepared to lead from the shadows.", 
            "<span class='highlight-text'>Stay prepared to lead from the shadows.</span>"
          );
          enterBtn.style.opacity = '1';
          enterBtn.style.pointerEvents = 'auto';
        });
      }, 500);
    });

    enterBtn.addEventListener('click', () => {
      audio.startBgm();
      if (typeof gtag === 'function') {
        gtag('event', 'game_start', { 'event_category': 'engagement' });
      }
      loadingOverlay.style.transition = 'opacity 1s';
      loadingOverlay.style.opacity = '0';
      setTimeout(() => {
        loadingOverlay.style.display = 'none';
        processTurn(); 
      }, 1000);
    });

    // --- MAIN GAME LOOP ---
    const term = document.getElementById('terminal');
    const inp = document.getElementById('choiceInput');
    const subBtn = document.getElementById('submitBtn');
    const container = document.getElementById('game-container');
    let waiting = false;

    function processTurn(choice = null) {
      const res = advanceDay(choice);

      if(res.critical) container.classList.add('critical');
      else container.classList.remove('critical');

      inp.disabled = true; 
      subBtn.disabled = true;

      if(res.news) {
        showNews(res.news, res);
      } else {
        displayTurn(res);
      }
    }

    function displayTurn(res) {
      const block = document.createElement('div');
      block.style.marginBottom = "25px";
      term.appendChild(block);

      typeText(block, res.text, 5, () => {
        if(res.ended) {
          audio.bgm.pause();
          document.getElementById('restartBtn').style.display = 'block';
          if (typeof gtag === 'function') {
            gtag('event', 'game_over', { 'result': res.text.split('\n')[0] });
          }
        } else {
          waiting = true;
          inp.disabled = false; 
          subBtn.disabled = false;
          inp.focus();
        }
      });
    }

    // --- INPUT HANDLING ---
    subBtn.addEventListener('click', () => {
      if(!waiting) return;
      const v = parseInt(inp.value);
      if(isNaN(v)) return;
      
      waiting = false; 
      inp.value = "";
      processTurn(v - 1);
    });

    inp.addEventListener('keydown', e => { 
      if(e.key === 'Enter') subBtn.click(); 
    });
    
    document.getElementById('restartBtn').addEventListener('click', () => location.reload());
  </script>
</body>
</html>
